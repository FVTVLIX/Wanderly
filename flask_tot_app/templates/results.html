<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results | Wanderly</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="nav-logo">WANDERLY</a>
            <div class="nav-links">
                <a href="{{ url_for('index') }}">New Search</a>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('profile') }}">My Profile</a>
                {% else %}
                <a href="{{ url_for('login') }}">Login</a>
                {% endif %}
                <button id="darkModeToggle" class="btn-secondary-sm"
                    style="border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <header class="results-header">
            <p style="font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.5rem;">
                Strategic Analysis</p>
            <h1 class="serif-italic" style="font-size: 4rem; transform: rotate(-1deg);">{{ problem }}</h1>
        </header>

        {% if not strategies %}
        <div class="empty-state"
            style="background: #FFF; padding: 3rem; border: 3px solid #000; text-align: center; max-width: 600px; margin: 0 auto; box-shadow: 8px 8px 0px #000;">
            <h2 style="margin-bottom: 1rem;">No strategies generated.</h2>
            <p style="margin-bottom: 2rem;">Please try again or refine your search.</p>
            <a href="{{ url_for('index') }}" class="btn-primary">New Search</a>
        </div>
        {% endif %}

        {% for strategy in strategies %}
        <article class="strategy-card">
            <div class="strategy-header">
                <h2 style="font-size: 2rem;">{{ strategy.title }}</h2>
                <div class="score-badge" style="background: #FFF; color: #000; transform: rotate(3deg);">{{
                    strategy.score }}/10</div>
            </div>

            <div class="strategy-body">
                <p style="font-size: 1.1rem; margin-bottom: 2rem; font-weight: 500;">{{ strategy.summary }}</p>

                <div class="strategy-stats">
                    <div class="stat-item">
                        <i class="fa-solid fa-coins"></i>
                        <span>Est. Cost: See Breakdown</span>
                    </div>
                    <div class="stat-item">
                        <i class="fa-solid fa-location-dot"></i>
                        <span>{{ strategy.locations | length }} Stops</span>
                    </div>
                </div>

                <div class="info-card" style="margin-bottom: 2rem; background: #f9f9f9;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Cost Breakdown</h3>
                    {% if strategy.cost_breakdown is mapping %}
                    <table style="width: 100%; border-collapse: collapse;">
                        {% for category, amount in strategy.cost_breakdown.items() %}
                        {% if category != 'currency' and category != 'total' %}
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 0.5rem 0; text-transform: capitalize;">{{ category }}</td>
                            <td style="padding: 0.5rem 0; text-align: right; font-weight: 600;">{{ amount }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        <tr style="border-top: 2px solid #000;">
                            <td style="padding: 0.5rem 0; font-weight: 700;">TOTAL</td>
                            <td style="padding: 0.5rem 0; text-align: right; font-weight: 700;">{{
                                strategy.cost_breakdown.get('total', 'N/A') }}</td>
                        </tr>
                    </table>
                    {% else %}
                    <p>{{ strategy.cost_breakdown }}</p>
                    {% endif %}
                </div>

                <div class="info-card" style="margin-bottom: 2rem; background: #f9f9f9;">
                    <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">AI Critique</h3>
                    <p>{{ strategy.critique }}</p>
                </div>

                <div style="text-align: right;">
                    {% if current_user.is_authenticated %}
                    <button onclick='saveStrategy({{ strategy | tojson }})' class="btn-primary">
                        Save to Profile <i class="fa-regular fa-bookmark"></i>
                    </button>
                    {% else %}
                    <a href="{{ url_for('login') }}" class="btn-secondary-sm">Login to Save</a>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    <script>
        // Dark Mode Logic
        const toggleBtn = document.getElementById('darkModeToggle');
        const body = document.body;
        const icon = toggleBtn.querySelector('i');

        // Check local storage
        if (localStorage.getItem('darkMode') === 'enabled') {
            body.classList.add('dark-mode');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        }

        toggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');

            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                localStorage.setItem('darkMode', 'disabled');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });

        function saveStrategy(strategyData) {
            fetch('/save_strategy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(strategyData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Strategy saved to your profile!');
                        window.location.href = "{{ url_for('profile') }}";
                    }
                });
        }
    </script>
</body>

</html>